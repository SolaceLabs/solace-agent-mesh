log:
  stdout_log_level: INFO
  log_file_level: DEBUG
  log_file: workflow_test.log

!include ../shared_config.yaml


apps:
  # ============================================================================
  # AGENT 1: Risk Evaluator
  # Logic: amount > 100 = high risk
  # ============================================================================
  - name: risk_evaluator_app
    app_base_path: .
    app_module: solace_agent_mesh.agent.sac.app
    broker:
      <<: *broker_connection

    app_config:
      namespace: ${NAMESPACE}
      agent_name: "RiskEvaluator"
      model: *planning_model
      
      # Strict instruction to ensure it behaves like a function
      instruction: |
        You are a risk evaluation engine. 
        1. Read the 'amount' from the input.
        2. If amount > 100, risk_level is "high". Otherwise "low".
        3. Create a JSON artifact "risk_result.json" with: {"risk_level": "..."}
        4. End with: «result:artifact=risk_result.json status=success»

      input_schema:
        type: object
        properties:
          amount: {type: integer}
        required: [amount]

      output_schema:
        type: object
        properties:
          risk_level: {type: string, enum: ["high", "low"]}
        required: [risk_level]

      tools:
        - tool_type: builtin-group
          group_name: "artifact_management"

      session_service:
        <<: *default_session_service
      artifact_service:
        <<: *default_artifact_service
      
      agent_card:
        description: "Evaluates order risk based on amount"
        skills: [{id: "eval_risk", name: "Evaluate Risk", description: "Evaluates risk", tags: ["risk"]}]
      agent_card_publishing: { interval_seconds: 10 }
      agent_discovery: { enabled: false }

  # ============================================================================
  # AGENT 2: Auto Approver
  # Logic: Always approves
  # ============================================================================
  - name: auto_approver_app
    app_base_path: .
    app_module: solace_agent_mesh.agent.sac.app
    broker:
      <<: *broker_connection

    app_config:
      namespace: ${NAMESPACE}
      agent_name: "AutoApprover"
      model: *planning_model
      
      instruction: |
        You are an auto-approval bot.
        1. Create a JSON artifact "approval.json" with: {"status": "approved", "reason": "low_risk"}
        2. End with: «result:artifact=approval.json status=success»

      input_schema:
        type: object
        properties:
          order_id: {type: string}

      output_schema:
        type: object
        properties:
          status: {type: string}
        required: [status]

      tools:
        - tool_type: builtin-group
          group_name: "artifact_management"

      session_service:
        <<: *default_session_service
      artifact_service:
        <<: *default_artifact_service
      
      agent_card:
        description: "Approves low risk orders"
        skills: [{id: "approve", name: "Approve", description: "Approves order", tags: ["approval"]}]
      agent_card_publishing: { interval_seconds: 10 }
      agent_discovery: { enabled: false }

  # ============================================================================
  # AGENT 3: Manual Reviewer
  # Logic: Always flags for review
  # ============================================================================
  - name: manual_reviewer_app
    app_base_path: .
    app_module: solace_agent_mesh.agent.sac.app
    broker:
      <<: *broker_connection

    app_config:
      namespace: ${NAMESPACE}
      agent_name: "ManualReviewer"
      model: *planning_model
      
      instruction: |
        You are a manual review bot.
        1. Create a JSON artifact "review.json" with: {"status": "pending_review", "reason": "high_risk"}
        2. End with: «result:artifact=review.json status=success»

      input_schema:
        type: object
        properties:
          order_id: {type: string}

      output_schema:
        type: object
        properties:
          status: {type: string}
        required: [status]

      tools:
        - tool_type: builtin-group
          group_name: "artifact_management"

      session_service:
        <<: *default_session_service
      artifact_service:
        <<: *default_artifact_service
      
      agent_card:
        description: "Flags high risk orders"
        skills: [{id: "review", name: "Review", description: "Reviews order", tags: ["review"]}]
      agent_card_publishing: { interval_seconds: 10 }
      agent_discovery: { enabled: false }

  # ============================================================================
  # WORKFLOW: OrderProcessor
  # ============================================================================
  - name: order_processor_workflow
    app_base_path: .
    app_module: solace_agent_mesh.workflow.app
    broker:
      <<: *broker_connection

    app_config:
      namespace: ${NAMESPACE}
      agent_name: "OrderProcessor"
      display_name: "Order Processing Workflow"

      workflow:
        description: |
          A comprehensive order processing workflow that evaluates risk and routes orders accordingly.
          
          This workflow performs the following steps:
          1. Evaluates the risk level of the order based on the amount.
          2. Automatically approves low-risk orders (amount <= 100).
          3. Routes high-risk orders (amount > 100) for manual review.
          
          EXPECTED INPUT:
          You must provide a JSON object representing the order with the following fields:
          - order_id (string): The unique identifier for the order (e.g., "ORD-123").
          - amount (integer): The total amount of the order.
          
          Example Input: {"order_id": "ORD-123", "amount": 150}
          
          OUTPUT:
          The workflow returns a JSON object containing:
          - processed_order_id: The ID of the processed order.
          - final_status: The final status of the order ("approved" or "pending_review").

        input_schema:
          type: object
          properties:
            order_id: {type: string}
            amount: {type: integer}
          required: [order_id, amount]

        output_schema:
          type: object
          properties:
            final_status: {type: string}
            processed_order_id: {type: string}
          required: [final_status, processed_order_id]

        nodes:
          # Step 1: Check Risk
          - id: check_risk
            type: agent
            agent_name: "RiskEvaluator"
            input:
              amount: "{{workflow.input.amount}}"

          # Step 2: Branch
          - id: risk_branch
            type: conditional
            depends_on: [check_risk]
            # Note: simpleeval syntax
            condition: "'{{check_risk.output.risk_level}}' == 'high'"
            true_branch: send_to_review
            false_branch: auto_approve

          # Step 3a: High Risk
          - id: send_to_review
            type: agent
            agent_name: "ManualReviewer"
            depends_on: [risk_branch]
            input:
              order_id: "{{workflow.input.order_id}}"

          # Step 3b: Low Risk
          - id: auto_approve
            type: agent
            agent_name: "AutoApprover"
            depends_on: [risk_branch]
            input:
              order_id: "{{workflow.input.order_id}}"

        # Map output from whichever branch ran
        output_mapping:
          processed_order_id: "{{workflow.input.order_id}}"
          # Use coalesce to pick the status from whichever branch executed
          final_status:
            coalesce:
              - "{{send_to_review.output.status}}"
              - "{{auto_approve.output.status}}"

      session_service:
        <<: *default_session_service
      artifact_service:
        <<: *default_artifact_service
      
      agent_card_publishing: { interval_seconds: 10 }
      agent_discovery: { enabled: false }
