# nsjail configuration for SAM sandbox worker - Restrictive profile
# This profile provides maximum security with minimal capabilities.
# No network access, limited filesystem, strict resource limits.

name: "sam-tool-restrictive"

# Execute once and exit
mode: ONCE

# Hostname inside the sandbox
hostname: "sandbox"

# Working directory
cwd: "/sandbox/work"

# Time limit in seconds (shorter for restrictive mode)
time_limit: 60

# Resource limits (strict)
rlimit_as: 512           # 512MB virtual memory
rlimit_core: 0           # No core dumps
rlimit_cpu: 60           # 1 min CPU time
rlimit_fsize: 64         # 64MB max file size
rlimit_nofile: 128       # 128 open files

# CPU affinity (limit to 1 CPU)
max_cpus: 1

# Don't keep environment variables (more secure)
keep_env: false

# Set specific safe environment variables
envar: "PATH=/usr/bin:/usr/local/bin"
envar: "HOME=/sandbox"
envar: "TMPDIR=/tmp"
envar: "LANG=C.UTF-8"

# Disable network access
clone_newnet: true

# Mount configuration - minimal
mount {
    src: "/proc"
    dst: "/proc"
    is_bind: true
}

mount {
    dst: "/dev"
    fstype: "tmpfs"
    rw: true
}

mount {
    src: "/dev/null"
    dst: "/dev/null"
    is_bind: true
    rw: true
}

mount {
    src: "/dev/zero"
    dst: "/dev/zero"
    is_bind: true
}

mount {
    src: "/dev/urandom"
    dst: "/dev/urandom"
    is_bind: true
}

# Mount system libraries (read-only)
mount {
    src: "/lib"
    dst: "/lib"
    is_bind: true
}

mount {
    src: "/usr/lib"
    dst: "/usr/lib"
    is_bind: true
}

# Mount Python installation
mount {
    src: "/usr/bin"
    dst: "/usr/bin"
    is_bind: true
}

mount {
    src: "/usr/local"
    dst: "/usr/local"
    is_bind: true
}

# Small temporary directory
mount {
    dst: "/tmp"
    fstype: "tmpfs"
    rw: true
}

# Mount sandbox work directory
mount {
    src: "/sandbox/work"
    dst: "/sandbox/work"
    is_bind: true
    rw: true
}
