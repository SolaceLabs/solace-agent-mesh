# nsjail configuration for SAM sandbox worker - Standard profile
# This profile provides balanced security with reasonable capabilities.

name: "sam-tool-standard"

# Execute once and exit
mode: ONCE

# Hostname inside the sandbox
hostname: "sandbox"

# Working directory
cwd: "/sandbox/work"

# Time limit in seconds (can be overridden via command line)
time_limit: 300

# Resource limits
rlimit_as: 1024          # 1GB virtual memory
rlimit_core: 0           # No core dumps
rlimit_cpu: 300          # 5 min CPU time
rlimit_fsize: 256        # 256MB max file size
rlimit_nofile: 512       # 512 open files

# CPU affinity (limit to 2 CPUs)
max_cpus: 2

# Keep environment variables from parent
keep_env: true

# Mount configuration
# Mount proc filesystem (required for Python)
mount {
    src: "/proc"
    dst: "/proc"
    is_bind: true
}

# Mount dev filesystem (minimal)
mount {
    dst: "/dev"
    fstype: "tmpfs"
    rw: true
}

mount {
    src: "/dev/null"
    dst: "/dev/null"
    is_bind: true
    rw: true
}

mount {
    src: "/dev/zero"
    dst: "/dev/zero"
    is_bind: true
}

mount {
    src: "/dev/urandom"
    dst: "/dev/urandom"
    is_bind: true
}

# Mount system libraries (read-only)
mount {
    src: "/lib"
    dst: "/lib"
    is_bind: true
}

mount {
    src: "/usr/lib"
    dst: "/usr/lib"
    is_bind: true
}

# Mount Python installation
mount {
    src: "/usr/bin"
    dst: "/usr/bin"
    is_bind: true
}

mount {
    src: "/usr/local"
    dst: "/usr/local"
    is_bind: true
}

# Temporary directory
mount {
    dst: "/tmp"
    fstype: "tmpfs"
    rw: true
}

# Mount sandbox work directory
mount {
    src: "/sandbox/work"
    dst: "/sandbox/work"
    is_bind: true
    rw: true
}

# Mount /etc for basic system files (DNS, etc.)
mount {
    src: "/etc/resolv.conf"
    dst: "/etc/resolv.conf"
    is_bind: true
}

mount {
    src: "/etc/hosts"
    dst: "/etc/hosts"
    is_bind: true
}

mount {
    src: "/etc/ssl"
    dst: "/etc/ssl"
    is_bind: true
}
