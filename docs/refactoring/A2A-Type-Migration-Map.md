# A2A Type Migration Map

## 1. Introduction

This document is a guide for migrating the Solace Agent Mesh (SAM) codebase from its legacy A2A data models (defined in `src/solace_agent_mesh/common/types.py`) to the official types provided by the `a2a-sdk` library (in `a2a.types`).

The primary goals of this migration are to achieve full compliance with the latest A2A specification and to standardize how we communicate non-visible status information.

**Key Principles:**
-   **Adopt SDK Types:** All legacy Pydantic models for A2A objects will be replaced by their `a2a.types` counterparts.
-   **Standardize Status Updates:** The practice of embedding custom status signals (e.g., `tool_invocation_start`) in the `metadata` field of a message will be replaced by using a dedicated, structured `DataPart` within a multi-part `Message`.

This document provides a model-by-model mapping and highlights the required actions for a successful migration.

---

## 2. Core Concept Changes

### 2.1. Task and Session Identification

This is a fundamental semantic change in the protocol.

| Legacy Concept | New Concept | Action Required |
| --- | --- | --- |
| `Task.sessionId` | `Message.contextId` | The concept of a session is now attached to the `Message` via `contextId`. The `Task` object itself has a `contextId` but it's primarily for grouping related tasks. All code that previously relied on `Task.sessionId` must be updated to use `Message.contextId` for tracking conversation history. |
| `TaskSendParams.id` | `Task.id` | The client-generated task ID from the legacy `TaskSendParams` is now the official `Task.id`. The server no longer generates a new ID for the task. |

### 2.2. Request and Response Structure

The structure of JSON-RPC requests and responses is now more strictly defined by the SDK.

| Legacy Model | New Model (`a2a.types`) | Action Required |
| --- | --- | --- |
| `TaskSendParams` | `SendMessageRequest` | The legacy `TaskSendParams` is fully replaced. The `message` and other parameters are now nested inside the `params` field of a `SendMessageRequest` object. |
| `JSONRPCResponse` | `JSONRPCResponse` (RootModel) | The new `JSONRPCResponse` is a discriminated union of all possible success and error responses. This provides stronger typing. |
| `A2ARequest` (TypeAdapter) | `A2ARequest` (RootModel) | The new `A2ARequest` is a discriminated union of all possible request types, using the `method` field as the discriminator. |

---

## 3. Model-by-Model Migration Map

### 3.1. `Message`

| Legacy Field (`common/types.py`) | New Field (`a2a.types`) | Notes / Action Required |
| --- | --- | --- |
| `role: Literal["user", "agent"]` | `role: Role` (Enum) | Functionally the same. `Role` is an enum with `agent` and `user` values. |
| `parts: List[Part]` | `parts: list[Part]` | The structure of `Part` itself has changed (see below). |
| `metadata: dict` | `metadata: dict` | Still exists for custom metadata, but its use for status signaling is now deprecated. |
| (Not present) | `messageId: str` | **Required.** A unique ID for the message, generated by the sender. Must be added to all created `Message` objects. |
| (Not present) | `contextId: str \| None` | **Required for context.** This field replaces `sessionId`. It should be used to group messages within a single conversation. |
| (Not present) | `kind: Literal['message']` | **Required.** A new discriminator field. Must be set to `"message"`. |
| (Not present) | `taskId: str \| None` | The ID of the task this message belongs to. |

### 3.2. `Part` and its Subtypes

The core change is the use of `kind` as the discriminator instead of `type`.

| Legacy Model/Field | New Model/Field (`a2a.types`) | Notes / Action Required |
| --- | --- | --- |
| `Part` (Union, `type` discriminator) | `Part` (RootModel, `kind` discriminator) | All code that checks `part.type` must be changed to check `part.kind`. |
| `TextPart.type` | `TextPart.kind` | Change `type="text"` to `kind="text"`. |
| `FilePart.type` | `FilePart.kind` | Change `type="file"` to `kind="file"`. |
| `FilePart.file: FileContent` | `FilePart.file: FileWithBytes \| FileWithUri` | The `FileContent` model is replaced by a union. Code must now handle either `FileWithBytes` (with a `bytes` field) or `FileWithUri` (with a `uri` field). |
| `DataPart.type` | `DataPart.kind` | Change `type="data"` to `kind="data"`. |
| `DataPart.data: dict` | `DataPart.data: dict` | No change. This is the key field for our new status signaling. |

### 3.3. `Task`

| Legacy Field (`common/types.py`) | New Field (`a2a.types`) | Notes / Action Required |
| --- | --- | --- |
| `id: str` | `id: str` | No change. This is the unique ID for the task. |
| `sessionId: str` | `contextId: str` | **Major Change.** The session identifier is now `contextId`. All references must be updated. |
| `status: TaskStatus` | `status: TaskStatus` | The structure of `TaskStatus` has changed (see below). |
| `artifacts: List[Artifact]` | `artifacts: list[Artifact]` | The structure of `Artifact` has changed slightly. |
| `history: List[Message]` | `history: list[Message]` | No major change, but the `Message` objects within the history will follow the new format. |
| (Not present) | `kind: Literal['task']` | **Required.** A new discriminator field. Must be set to `"task"`. |

### 3.4. `TaskStatus` and `TaskStatusUpdateEvent`

This is where the most significant structural change occurs for status updates.

| Legacy Model/Field | New Model/Field (`a2a.types`) | Notes / Action Required |
| --- | --- | --- |
| `TaskStatus.state: TaskState` | `TaskStatus.state: TaskState` | Enum values are the same (e.g., "working", "completed"). |
| `TaskStatus.message: Message` | `TaskStatus.message: Message` | No change in field name, but the `Message` object will now carry the structured `DataPart` for status signals. |
| `TaskStatusUpdateEvent.id` | `TaskStatusUpdateEvent.taskId` | The field identifying the task has been renamed from `id` to `taskId`. |
| (Not present) | `TaskStatusUpdateEvent.contextId` | A new required field for the session/conversation ID. |
| (Not present) | `TaskStatusUpdateEvent.kind` | **Required.** A new discriminator field, must be `"status-update"`. |
| `TaskStatusUpdateEvent.final: bool` | `TaskStatusUpdateEvent.final: bool` | No change. |
| `TaskStatusUpdateEvent.metadata: dict` | `TaskStatusUpdateEvent.metadata: dict` | Still exists, but should no longer be used for status signaling. |

---

## 4. Example: Migrating a Status Update

This example shows how to migrate the `tool_invocation_start` signal from the legacy `metadata` field to the new `DataPart` structure.

### Before Refactoring

The status signal is a custom dictionary inside the `metadata` field of a `Message`.

```json
{
  "jsonrpc": "2.0",
  "id": "rpc-id-123",
  "result": {
    "id": "task-abc",
    "final": false,
    "status": {
      "state": "working",
      "message": {
        "role": "agent",
        "parts": [],
        "metadata": {
          "type": "tool_invocation_start",
          "data": {
            "tool_name": "web_request",
            "tool_args": { "url": "https://example.com" },
            "function_call_id": "call-xyz"
          }
        }
      }
    }
  }
}
```

### After Refactoring

The status signal is now a structured `DataPart` within the `Message`'s `parts` array. This is explicit, type-safe, and compliant with the A2A specification.

```json
{
  "jsonrpc": "2.0",
  "id": "rpc-id-123",
  "result": {
    "kind": "status-update",
    "taskId": "task-abc",
    "contextId": "session-456",
    "final": false,
    "status": {
      "state": "working",
      "message": {
        "kind": "message",
        "messageId": "msg-def",
        "role": "agent",
        "parts": [
          {
            "kind": "data",
            "data": {
              "type": "tool_invocation_start",
              "tool_name": "web_request",
              "tool_args": { "url": "https://example.com" },
              "function_call_id": "call-xyz"
            }
          }
        ]
      }
    }
  }
}
```
