# A2A SDK Migration: Phase 1 Implementation Plan

## 1. Objective

This document provides a step-by-step implementation plan for Phase 1 of the A2A SDK Migration. The goal is to refactor the backend components and validate them using the test infrastructure, ensuring full compliance with the latest A2A specification before impacting user-facing gateways or the UI.

## 2. Implementation Steps

The work is broken down into logical sections. It is recommended to follow them in the specified order to manage dependencies effectively.

### Section A: Schema and Data Model Setup

This section establishes the data contracts for our new structured status messages.

1.  **Create JSON Schemas for `DataPart`:**
    *   Create a new directory: `src/solace_agent_mesh/common/a2a_spec/schemas/`.
    *   Inside this directory, create the following JSON schema files as defined in the Phase 1 Design Document:
        *   `tool_invocation_start.json`
        *   `llm_invocation.json`
        *   `agent_progress_update.json`
        *   `artifact_creation_progress.json`

2.  **Generate Pydantic Models from Schemas:**
    *   Create a new file: `src/solace_agent_mesh/common/data_parts.py`.
    *   Use a tool like `datamodel-code-generator` or manually create Pydantic `BaseModel` classes in this file that correspond to each JSON schema created in the previous step. This will give us strongly-typed objects for use in the backend.

### Section B: Refactor Agent Request Handling

This section updates the agent's entry point to understand the new A2A request format.

3.  **Update `event_handlers.py` Imports:**
    *   In `src/solace_agent_mesh/agent/protocol/event_handlers.py`, remove all imports from the legacy `...common.types` and replace them with imports from `a2a.types`.

4.  **Refactor `handle_a2a_request`:**
    *   In `handle_a2a_request`, replace the line `A2ARequest.validate_python(payload_dict)` with `A2ARequest.model_validate(payload_dict)`.
    *   Update the `isinstance` checks to inspect the `.root` attribute of the new `A2ARequest` model (e.g., `isinstance(a2a_request.root, a2a.types.CancelTaskRequest)`).
    *   In the `SendTaskRequest` / `SendTaskStreamingRequest` block:
        *   Generate a new `taskId` using `uuid.uuid4().hex`. This will be the `logical_task_id`.
        *   Extract `contextId` from `a2a_request.root.params.message.contextId`. This will replace `original_session_id`.
        *   Extract `messageId` from `a2a_request.root.params.message.messageId`.
        *   Update the `a2a_context` dictionary to store `taskId`, `contextId`, and `messageId`.
    *   In the `CancelTaskRequest` block:
        *   Extract the `taskId` to cancel from `a2a_request.root.params.id`.
        *   Update the logic that finds the task in `component.active_tasks` to use this `taskId`.

### Section C: Refactor Status Update Generation

This section implements the core design change of using `DataPart` for status signals.

5.  **Update `callbacks.py` Imports:**
    *   In `src/solace_agent_mesh/agent/adk/callbacks.py`, replace legacy type imports with `a2a.types` and the new `DataPart` Pydantic models from `common.data_parts`.

6.  **Refactor `notify_tool_invocation_start_callback`:**
    *   Instantiate the new `ToolInvocationStartData` Pydantic model with the tool name and arguments.
    *   Create an `a2a.types.DataPart` using the `.model_dump()` of the data model from the previous step.
    *   Create an `a2a.types.Message` containing this `DataPart` in its `parts` array. Ensure `messageId` and `kind` are set.
    *   Wrap the `Message` in `a2a.types.TaskStatus` and then `a2a.types.TaskStatusUpdateEvent`.
    *   Ensure the new `TaskStatusUpdateEvent` includes the `taskId` and `contextId` from the `a2a_context`.
    *   Update the call to `_publish_status_update_with_buffer_flush` to send this new event object.

7.  **Refactor Other Status Callbacks:**
    *   Apply the same pattern from step #6 to `solace_llm_invocation_callback` (using `LlmInvocationData`) and the progress update logic in `process_artifact_blocks_callback` (using `ArtifactCreationProgressData`).

### Section D: Refactor Peer Agent Delegation

This section ensures agent-to-agent communication is compliant.

8.  **Update `peer_agent_tool.py`:**
    *   In `run_async`, when preparing the `A2AMessage` for the peer:
        *   Generate a new, unique `messageId` using `uuid.uuid4().hex`.
        *   Propagate the `contextId` from the parent task's `a2a_context` to the `message.contextId` field.
    *   In `submit_a2a_task` (in `src/solace_agent_mesh/agent/sac/component.py`):
        *   Modify the method to accept the new `a2a.types.SendMessageRequest`.
        *   Remove the logic that sets a client-defined `id` in the `TaskSendParams`. The `taskId` will now be generated by the peer.

9.  **Update Peer Response Correlation Logic:**
    *   In `handle_a2a_response` in `event_handlers.py`, the logic for handling responses from peers needs to be adapted.
    *   The `sub_task_id` will now be the *correlation ID* generated by the `PeerAgentTool`, not the actual `taskId`.
    *   When the first response for a sub-task arrives, extract the peer-generated `taskId` from the payload and store it in the `correlation_data` for that sub-task.
    *   All subsequent status updates for that sub-task will be correlated using this newly learned `taskId`.

### Section E: Update Test Infrastructure

This section refactors the test client and fixtures to align with the new protocol.

10. **Refactor `TestGatewayComponent`:**
    *   In `submit_a2a_task` (or equivalent method), change the logic to instantiate `a2a.types.Message` and `a2a.types.SendMessageRequest`. Populate all new required fields like `messageId` and `contextId`.
    *   Serialize the final request object to a dictionary using `.model_dump(by_alias=True, exclude_none=True)` before publishing.
    *   In the response handling logic (e.g., `_handle_agent_event`), parse incoming payloads into `a2a.types.JSONRPCResponse` using `.model_validate()`.
    *   Update test assertions to check for the new data structures (e.g., inspect `message.parts` for a `DataPart` instead of checking `message.metadata`).

11. **Update Test Fixtures in `conftest.py`:**
    *   Locate all fixtures that create mock A2A message dictionaries (e.g., `mock_task_response`, `mock_sse_task_response`).
    *   Update these dictionaries to match the new `a2a.json` schema. This includes adding required fields (`kind`, `messageId`, `contextId`, `taskId`), renaming fields (`sessionId` -> `contextId`), and nesting structures correctly.

### Section F: Final Validation

12. **Execute and Validate:**
    *   Run the full integration test suite.
    *   Systematically debug and fix any failing tests. Use the refactored `A2AMessageValidator` and logs to identify protocol mismatches between the `TestGatewayComponent` and the `SamAgentComponent`.
    *   The goal for this phase is a 100% passing integration test suite, which confirms the backend refactoring is complete and correct.
