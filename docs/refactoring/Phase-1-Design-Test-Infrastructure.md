# Phase 1 Design: Test Infrastructure Refactoring

## 1. Overview

This document outlines the detailed design for refactoring the `sam-test-infrastructure` library to align with the official `a2a-sdk` and the latest A2A protocol specification. The primary goal is to ensure that the test infrastructure, which simulates external clients and gateways, can correctly create, send, receive, and parse the new A2A-compliant messages.

The core of this effort is focused on the `TestGatewayComponent`, which acts as the primary test client in our integration test suite. We will also update the `MemoryMonitor` to track the new SDK-based object types.

## 2. Guiding Principles

-   **Full SDK Adoption:** All A2A-related data structures will be replaced with their `a2a.types` equivalents.
-   **Protocol Compliance:** All message creation and parsing logic will adhere strictly to the `a2a.json` schema.
-   **Minimal Disruption:** Changes will be contained within the test infrastructure, avoiding modifications to the core test case logic where possible.

## 3. Component-Specific Design

### 3.1. `TestGatewayComponent` (`gateway_interface/component.py`)

This component is the central point of interaction for integration tests and requires the most significant changes.

#### 3.1.1. Type System Migration

All internal type hints and imports related to the legacy A2A protocol will be replaced.

-   **Action:** Replace imports from `solace_agent_mesh.common.types` with `a2a.types`.
-   **Mapping:**
    -   `solace_agent_mesh.common.types.Part` -> `a2a.types.Part`
    -   `solace_agent_mesh.common.types.TextPart` -> `a2a.types.TextPart`
    -   `solace_agent_mesh.common.types.FilePart` -> `a2a.types.FilePart`
    -   `solace_agent_mesh.common.types.DataPart` -> `a2a.types.DataPart`
    -   `solace_agent_mesh.common.types.Task` -> `a2a.types.Task`
    -   `solace_agent_mesh.common.types.TaskStatusUpdateEvent` -> `a2a.types.TaskStatusUpdateEvent`
    -   `solace_agent_mesh.common.types.TaskArtifactUpdateEvent` -> `a2a.types.TaskArtifactUpdateEvent`
    -   `solace_agent_mesh.common.types.JSONRPCError` -> `a2a.types.JSONRPCError`

#### 3.1.2. Task Submission Logic (`submit_a2a_task`)

The `submit_a2a_task` method must be updated to construct fully compliant A2A requests.

-   **A2AMessage Construction:**
    -   The method will now construct an `a2a.types.Message` object.
    -   **`messageId`**: A new UUID will be generated for this required field.
    -   **`contextId`**: The `a2a_session_id` from the `external_request_context` will be used for this field. This replaces the legacy `sessionId` concept.
    -   **`kind`**: This required discriminator field will be set to `"message"`.
    -   **`parts`**: The `a2a_parts` list will be used as before, but the objects within it will be the new `a2a.types` models.

-   **JSON-RPC Request Wrapping:**
    -   The constructed `A2AMessage` will be wrapped in `a2a.types.MessageSendParams`.
    -   This `MessageSendParams` object will be used to create either a `a2a.types.SendMessageRequest` or `a2a.types.SendStreamingMessageRequest`, depending on the `is_streaming` flag.
    -   The `id` of the JSON-RPC request will be set to the `task_id` generated by the gateway.

-   **Serialization:**
    -   The final request object will be serialized to a dictionary using `.model_dump(by_alias=True, exclude_none=True)` before being passed to `publish_a2a_message`.

#### 3.1.3. Response Handling Logic (`_handle_agent_event`, `_process_parsed_a2a_event`)

The logic for parsing and processing responses from the agent under test must be updated.

-   **Initial Parsing (`_handle_agent_event`):**
    -   The incoming payload dictionary will be parsed into an `a2a.types.JSONRPCResponse` object using `JSONRPCResponse.model_validate(payload)`. This provides robust validation against the entire response envelope.

-   **Result Extraction:**
    -   The `result` or `error` object will be accessed via `rpc_response.root.result` or `rpc_response.root.error`.

-   **Event Parsing (`_parse_a2a_event_from_rpc_result`):**
    -   This new helper method will be responsible for parsing the `result` dictionary into a specific A2A event model (`Task`, `TaskStatusUpdateEvent`, etc.).
    -   It will use the `kind` field (e.g., `"task"`, `"status-update"`) as the primary discriminator to determine which Pydantic model to use for validation.
    -   It will also validate that the `taskId` in the event matches the `task_id` extracted from the response topic to prevent context mismatches.

#### 3.1.4. Output Capture and Retrieval

The types used for storing and retrieving captured outputs for test assertions must be updated.

-   **`_captured_outputs` Queue:** The type hint for this `defaultdict(asyncio.Queue)` will be updated to reflect that it stores the new `a2a.types` models (e.g., `Union[Task, TaskStatusUpdateEvent, ...]`).
-   **`get_next_captured_output` and `get_all_captured_outputs`**: The return type hints for these methods will be updated to match the new types stored in the queue.

### 3.2. `MemoryMonitor` (`memory_monitor/memory_monitor.py`)

This utility requires a minor update to ensure it tracks the correct object types during memory leak analysis.

-   **Tracked Classes:**
    -   The `self.classes_to_track` list will be modified.
    -   **Action:** Replace the import `from solace_agent_mesh.common.types import Task, TaskStatusUpdateEvent` with `from a2a.types import Task, TaskStatusUpdateEvent`.
    -   The list initialization will now reference these new `a2a.types` classes. This ensures that the `objgraph.count` calls are monitoring the correct, new objects.

This design covers all necessary changes to align the test infrastructure with the `a2a-sdk`, ensuring that our integration tests are validating against the correct protocol and that our test utilities are monitoring the correct objects.
