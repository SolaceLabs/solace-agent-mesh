## Quick Summary

The repository directory implements the data access layer for the HTTP SSE gateway using the Repository pattern. It provides a clean separation between domain entities and database persistence through SQLAlchemy ORM models. The architecture consists of abstract interfaces, concrete implementations, domain entities with business logic, and SQLAlchemy models for database operations. The two main subdirectories (entities and models) work together to provide a complete data persistence solution for chat sessions and messages.

## Files and Subdirectories Overview

**Direct files:**
- `__init__.py` - Main package exports for repository interfaces, implementations, entities, and models
- `interfaces.py` - Abstract repository interfaces defining data access contracts
- `message_repository.py` - SQLAlchemy implementation of message data access operations
- `session_repository.py` - SQLAlchemy implementation of session data access operations

**Subdirectories:**
- `entities/` - Domain entities with business logic for sessions, messages, and session history
- `models/` - SQLAlchemy ORM models for database persistence and schema definition

## Developer API Reference

### Direct Files

#### __init__.py
**Purpose:** Central package exports for all repository components
**Import:** `from solace_agent_mesh.gateway.http_sse.repository import IMessageRepository, ISessionRepository, MessageRepository, SessionRepository, Session, Message, SessionHistory, Base, MessageModel, SessionModel`

**Exports:**
- `IMessageRepository` - Message repository interface
- `ISessionRepository` - Session repository interface  
- `MessageRepository` - Message repository implementation
- `SessionRepository` - Session repository implementation
- `Message` - Message domain entity
- `Session` - Session domain entity
- `SessionHistory` - Session with messages composite entity
- `Base` - SQLAlchemy declarative base
- `MessageModel` - SQLAlchemy message model
- `SessionModel` - SQLAlchemy session model

#### interfaces.py
**Purpose:** Defines abstract repository interfaces for data access contracts
**Import:** `from solace_agent_mesh.gateway.http_sse.repository.interfaces import ISessionRepository, IMessageRepository`

**Classes:**
- `ISessionRepository(ABC)` - Abstract interface for session data operations
  - `find_by_user(user_id: UserId, pagination: PaginationInfo | None = None) -> list[Session]` - Find all sessions for a user
  - `find_user_session(session_id: SessionId, user_id: UserId) -> Session | None` - Find specific user session
  - `save(session: Session) -> Session` - Save or update a session
  - `delete(session_id: SessionId, user_id: UserId) -> bool` - Delete user session
  - `find_user_session_with_messages(session_id: SessionId, user_id: UserId, pagination: PaginationInfo | None = None) -> tuple[Session, list[Message]] | None` - Find session with messages

- `IMessageRepository(ABC)` - Abstract interface for message data operations
  - `find_by_session(session_id: SessionId, pagination: PaginationInfo | None = None) -> list[Message]` - Find messages in session
  - `save(message: Message) -> Message` - Save or update a message
  - `delete_by_session(session_id: SessionId) -> bool` - Delete all session messages

#### message_repository.py
**Purpose:** SQLAlchemy implementation of message repository interface
**Import:** `from solace_agent_mesh.gateway.http_sse.repository.message_repository import MessageRepository`

**Classes:**
- `MessageRepository(IMessageRepository)` - SQLAlchemy message repository implementation
  - `__init__(db: DBSession)` - Initialize with database session
  - `find_by_session(session_id: SessionId, pagination: PaginationInfo | None = None) -> list[Message]` - Find messages in session with pagination
  - `save(message: Message) -> Message` - Save or update message in database
  - `delete_by_session(session_id: SessionId) -> bool` - Delete all messages in session
  - `_model_to_entity(model: MessageModel) -> Message` - Convert SQLAlchemy model to domain entity

#### session_repository.py
**Purpose:** SQLAlchemy implementation of session repository interface
**Import:** `from solace_agent_mesh.gateway.http_sse.repository.session_repository import SessionRepository`

**Classes:**
- `SessionRepository(ISessionRepository)` - SQLAlchemy session repository implementation
  - `__init__(db: DBSession)` - Initialize with database session
  - `find_by_user(user_id: UserId, pagination: PaginationInfo | None = None) -> list[Session]` - Find user sessions with pagination
  - `find_user_session(session_id: SessionId, user_id: UserId) -> Session | None` - Find specific user session
  - `save(session: Session) -> Session` - Save or update session in database
  - `delete(session_id: SessionId, user_id: UserId) -> bool` - Delete user session
  - `find_user_session_with_messages(session_id: SessionId, user_id: UserId, pagination: PaginationInfo | None = None) -> tuple[Session, list[Message]] | None` - Find session with messages
  - `_model_to_entity(model: SessionModel) -> Session` - Convert session model to entity
  - `_message_model_to_entity(model: MessageModel) -> Message` - Convert message model to entity

### Subdirectory APIs

#### entities/
**Purpose:** Provides domain entities with business logic for sessions, messages, and session history
**Key Exports:** Message, Session, SessionHistory
**Import Examples:**
```python
from solace_agent_mesh.gateway.http_sse.repository.entities import Message, Session, SessionHistory
```

#### models/
**Purpose:** Provides SQLAlchemy ORM models for database persistence and schema definition
**Key Exports:** Base, MessageModel, SessionModel
**Import Examples:**
```python
from solace_agent_mesh.gateway.http_sse.repository.models import Base, MessageModel, SessionModel
```

## Complete Usage Guide

### 1. Setting Up the Repository Layer

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from solace_agent_mesh.gateway.http_sse.repository import (
    Base, MessageRepository, SessionRepository
)

# Create database engine and session
engine = create_engine("sqlite:///chat.db")
Base.metadata.create_all(engine)
Session = sessionmaker(bind=engine)
db_session = Session()

# Initialize repositories
message_repo = MessageRepository(db_session)
session_repo = SessionRepository(db_session)
```

### 2. Working with Sessions

```python
from solace_agent_mesh.gateway.http_sse.repository.entities import Session
from solace_agent_mesh.gateway.http_sse.shared.types import PaginationInfo
import time

# Create a new session
session = Session(
    id="session_123",
    user_id="user_456",
    name="Customer Support Chat",
    agent_id="agent_789",
    created_time=int(time.time() * 1000)
)

# Save session
saved_session = session_repo.save(session)

# Find user sessions with pagination
pagination = PaginationInfo(page=1, page_size=10)
user_sessions = session_repo.find_by_user("user_456", pagination)

# Find specific session
found_session = session_repo.find_user_session("session_123", "user_456")

# Update session
if found_session:
    found_session.update_name("Updated Chat Name")
    session_repo.save(found_session)
```

### 3. Working with Messages

```python
from solace_agent_mesh.gateway.http_sse.repository.entities import Message
from solace_agent_mesh.gateway.http_sse.shared.enums import SenderType, MessageType

# Create a new message
message = Message(
    id="msg_123",
    session_id="session_123",
    message="Hello, how can I help you today?",
    sender_type=SenderType.AGENT,
    sender_name="Support Agent",
    message_type=MessageType.TEXT,
    created_time=int(time.time() * 1000)
)

# Validate and save message
message.validate_message_content()
saved_message = message_repo.save(message)

# Find messages in session
session_messages = message_repo.find_by_session("session_123", pagination)

# Check message properties
if message.is_from_agent():
    print("Message from agent")
```

### 4. Working with Session History (Combined Operations)

```python
from solace_agent_mesh.gateway.http_sse.repository.entities import SessionHistory

# Get session with messages in one operation
result = session_repo.find_user_session_with_messages(
    "session_123", "user_456", pagination
)

if result:
    session, messages = result
    
    # Create session history object
    history = SessionHistory(
        session=session,
        messages=messages,
        total_message_count=len(messages)
    )
    
    print(f"Session: {history.session.name}")
    print(f"Messages: {len(history.messages)}")
```

### 5. Using Repository Interfaces for Dependency Injection

```python
from solace_agent_mesh.gateway.http_sse.repository.interfaces import (
    ISessionRepository, IMessageRepository
)

class ChatService:
    def __init__(
        self, 
        session_repo: ISessionRepository,
        message_repo: IMessageRepository
    ):
        self.session_repo = session_repo
        self.message_repo = message_repo
    
    def create_chat_session(self, user_id: str, name: str) -> Session:
        session = Session(
            id=f"session_{int(time.time())}",
            user_id=user_id,
            name=name,
            created_time=int(time.time() * 1000)
        )
        return self.session_repo.save(session)
    
    def add_message(self, session_id: str, content: str, sender_type: SenderType) -> Message:
        message = Message(
            id=f"msg_{int(time.time())}",
            session_id=session_id,
            message=content,
            sender_type=sender_type,
            sender_name="User" if sender_type == SenderType.USER else "Agent",
            created_time=int(time.time() * 1000)
        )
        return self.message_repo.save(message)

# Usage with dependency injection
chat_service = ChatService(session_repo, message_repo)
```

### 6. Direct Database Model Access (Advanced)

```python
from solace_agent_mesh.gateway.http_sse.repository.models import SessionModel, MessageModel

# Direct SQLAlchemy queries (when repository methods aren't sufficient)
recent_sessions = db_session.query(SessionModel)\
    .filter(SessionModel.user_id == "user_456")\
    .order_by(SessionModel.updated_time.desc())\
    .limit(5)\
    .all()

# Join queries
session_with_message_count = db_session.query(
    SessionModel, 
    db_session.query(MessageModel.id).filter(
        MessageModel.session_id == SessionModel.id
    ).count().label('message_count')
).all()
```

### 7. Error Handling and Cleanup

```python
try:
    # Repository operations
    session = session_repo.save(new_session)
    message = message_repo.save(new_message)
    
except Exception as e:
    db_session.rollback()
    raise e
finally:
    db_session.close()
```

This repository layer provides a complete data access solution with clean separation of concerns, proper abstraction through interfaces, rich domain entities with business logic, and efficient SQLAlchemy-based persistence.

# content_hash: a5b00eb97df5fdbd1775ed185878c9fefefd648eac8a541e533519289c42e683
